<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Scraper - Main Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 20px auto;
            max-width: 1400px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            padding: 0 30px;
            background: #f8f9fa;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            font-weight: 500;
            padding: 15px 25px;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link:hover {
            background: #e9ecef;
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .content {
            padding: 30px;
        }
        .spider-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .spider-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .spider-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }
        .spider-site {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-running {
            background: #d4edda;
            color: #155724;
            animation: pulse 2s infinite;
        }
        .status-idle {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }
        .status-disabled {
            background: #e2e3e5;
            color: #383d41;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .last-update {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 10px;
        }
        .action-buttons {
            margin-top: 15px;
        }
        .btn-sm {
            padding: 5px 15px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .quick-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .quick-actions h4 {
            margin-bottom: 15px;
            color: #495057;
        }
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .btn-group-vertical .btn {
            text-align: left;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-spider"></i> News Scraper</h1>
            <p>Comprehensive news and document scraping system</p>
        </div>
        
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-chart-line"></i> Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="spiders-tab" data-bs-toggle="tab" data-bs-target="#spiders" type="button" role="tab">
                    <i class="fas fa-spider"></i> Spiders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                    <i class="fas fa-file-alt"></i> Logs
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="content">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" id="totalSpiders">-</div>
                            <div class="stat-label">Total Spiders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="runningSpiders">-</div>
                            <div class="stat-label">Running Now</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalArticles">-</div>
                            <div class="stat-label">Total Articles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="errorSpiders">-</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                        <div class="btn-group-vertical">
                            <a href="/dashboard" class="btn btn-primary">
                                <i class="fas fa-cogs"></i> Spider Control Panel
                            </a>
                            <a href="/logs" class="btn btn-info">
                                <i class="fas fa-file-alt"></i> View Live Logs
                            </a>
                            <button class="btn btn-success" onclick="startAllScheduled()">
                                <i class="fas fa-play"></i> Start All Scheduled Spiders
                            </button>
                            <button class="btn btn-warning" onclick="stopAllSpiders()">
                                <i class="fas fa-stop"></i> Stop All Spiders
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Spiders Tab -->
            <div class="tab-pane fade" id="spiders" role="tabpanel">
                <div class="content">
                    <div class="row" id="spidersGrid">
                        <!-- Spider cards will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="content">
                    <div class="text-center">
                        <h4><i class="fas fa-file-alt"></i> Live Logs</h4>
                        <p>View real-time spider and application logs</p>
                        <a href="/logs" class="btn btn-primary btn-lg">
                            <i class="fas fa-external-link-alt"></i> Open Logs Viewer
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Spider name to site mapping
        const spiderSiteMap = {
            'tass': 'tass.ru',
            'rbc': 'rbc.ru',
            'kommersant': 'kommersant.ru',
            'lenta': 'lenta.ru',
            'gazeta': 'gazeta.ru',
            'graininfo': 'graininfo.ru',
            'vedomosti': 'vedomosti.ru',
            'izvestia': 'iz.ru',
            'interfax': 'interfax.ru',
            'forbes': 'forbes.ru',
            'rg': 'rg.ru',
            'pnp': 'pnp.ru',
            'ria': 'ria.ru',
            'meduza': 'meduza.io',
            'government': 'government.ru',
            'kremlin': 'kremlin.ru',
            'regulation': 'regulation.gov.ru',
            'pravo': 'publication.pravo.gov.ru',
            'sozd': 'sozd.duma.gov.ru',
            'eaeu': 'docs.eaeunion.org',
        };

        // Get status class
        function getStatusClass(status) {
            switch(status) {
                case 'running': return 'status-running';
                case 'idle': return 'status-idle';
                case 'error': return 'status-error';
                case 'scheduled': return 'status-scheduled';
                case 'disabled': return 'status-disabled';
                default: return 'status-idle';
            }
        }

        // Get status label
        function getStatusLabel(status) {
            switch(status) {
                case 'running': return 'Running';
                case 'idle': return 'Idle';
                case 'error': return 'Error';
                case 'scheduled': return 'Scheduled';
                case 'disabled': return 'Disabled';
                default: return 'Unknown';
            }
        }

        // Update overview stats
        function updateStats(spiders) {
            const totalSpiders = spiders.length;
            const runningSpiders = spiders.filter(s => s.running_status === 'running').length;
            const errorSpiders = spiders.filter(s => s.running_status === 'error').length;
            
            document.getElementById('totalSpiders').textContent = totalSpiders;
            document.getElementById('runningSpiders').textContent = runningSpiders;
            document.getElementById('errorSpiders').textContent = errorSpiders;
            
            // Fetch total articles count
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalArticles').textContent = data.total_articles || 0;
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                    document.getElementById('totalArticles').textContent = '-';
                });
        }

        // Update spiders grid
        function updateSpidersGrid(spiders) {
            const grid = document.getElementById('spidersGrid');
            grid.innerHTML = '';
            
            spiders.forEach(spider => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-4';
                
                const site = spiderSiteMap[spider.name] || spider.name;
                const statusClass = getStatusClass(spider.running_status);
                const statusLabel = getStatusLabel(spider.running_status);
                
                card.innerHTML = `
                    <div class="spider-card">
                        <div class="spider-name">${spider.name}</div>
                        <div class="spider-site">${site}</div>
                        <div>
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="last-update">
                            Last update: ${spider.last_update || 'Never'}
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-sm" onclick="runSpider('${spider.name}')">
                                <i class="fas fa-play"></i> Run
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="stopSpider('${spider.name}')">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Fetch and update data
        function fetchData() {
            fetch('/api/scraper/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStats(data.spiders);
                        updateSpidersGrid(data.spiders);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Spider control functions
        function runSpider(name) {
            fetch(`/api/spiders/${name}/run`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        setTimeout(fetchData, 1000);
                    }
                })
                .catch(error => console.error('Error running spider:', error));
        }

        function stopSpider(name) {
            fetch(`/api/spiders/${name}/stop`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    setTimeout(fetchData, 1000);
                })
                .catch(error => console.error('Error stopping spider:', error));
        }

        function startAllScheduled() {
            fetch('/api/scraper/immediate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(fetchData, 1000);
                }
            })
            .catch(error => console.error('Error starting all spiders:', error));
        }

        function stopAllSpiders() {
            fetch('/api/scraper/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(fetchData, 1000);
                }
            })
            .catch(error => console.error('Error stopping all spiders:', error));
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            // Refresh data every 10 seconds
            setInterval(fetchData, 10000);
        });
    </script>
</body>
</html> 