<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Scraper Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-running { 
            color: #28a745; 
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .status-scheduled { color: #007bff; }
        .status-error { color: #dc3545; }
        .status-disabled { color: #6c757d; }
        
        .running-status-running {
            color: #28a745;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .running-status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .running-status-idle {
            color: #6c757d;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .btn:disabled {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: #ffffff !important;
            opacity: 1 !important;
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 4px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>News and Legislation Sites Scraping Dashboard</h1>
            <div>
                <a href="/" class="btn btn-outline-primary me-2">Main Dashboard</a> 
                <a href="/logs" class="btn btn-outline-info">View Logs</a>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col">
                <button class="btn btn-success" onclick="startAllSpiders()">Start All</button>
                <button class="btn btn-danger" onclick="stopAllSpiders()">Stop All</button>
                <span class="ms-3 text-muted" id="runningCount">Running: 0/5</span>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Site URL</th>
                        <th>Status</th>
                        <th>Running Status</th>
                        <th>Last Update</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="spiderTable">
                    <!-- Spider rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let runningSpiders = new Set();
        let statusPollingInterval;

        // Spider name to URL mapping
        const spiderSiteMap = {
            'tass': 'https://tass.ru/',
            'rbc': 'https://rbc.ru/',
            'kommersant': 'https://kommersant.ru/',
            'lenta': 'https://lenta.ru/',
            'gazeta': 'https://gazeta.ru/',
            'graininfo': 'https://graininfo.ru/',
            'vedomosti': 'https://vedomosti.ru/',
            'izvestia': 'https://iz.ru/',
            'interfax': 'https://interfax.ru/',
            'forbes': 'https://forbes.ru/',
            'rg': 'https://rg.ru/',
            'pnp': 'https://pnp.ru/',
            'ria': 'https://ria.ru/',
            'meduza': 'https://meduza.io/',
            'kremlin': 'https://kremlin.ru/',
            'government': 'https://government.ru/news/',
            'regulation': 'https://regulation.gov.ru/',
            'pravo': 'http://publication.pravo.gov.ru/',
            'sozd': 'https://sozd.duma.gov.ru/',
            'eaeu': 'https://docs.eaeunion.org/',
        };

        // Get status display info (manual control status only)
        function getStatusInfo(status) {
            // Handle manual control status only
            let displayStatus = status;
            let displayClass = '';
            
            if (status === 'scheduled') {
                displayStatus = 'Scheduled';
                displayClass = 'status-scheduled';
            } else if (status === 'disabled') {
                displayStatus = 'Disabled';
                displayClass = 'status-disabled';
            } else {
                displayStatus = status;
                displayClass = '';
            }
            
            return { label: displayStatus, class: displayClass };
        }

        // Get running status display info
        function getRunningStatusInfo(runningStatus) {
            if (runningStatus === 'running') {
                return { label: 'Running', class: 'running-status-running' };
            } else if (runningStatus === 'error') {
                return { label: 'Error', class: 'running-status-error' };
            } else {
                return { label: 'Idle', class: 'running-status-idle' };
            }
        }

        // Update running count display
        function updateRunningCount() {
            const runningCountElement = document.getElementById('runningCount');
            const currentRunning = runningSpiders.size;
            runningCountElement.textContent = `Running: ${currentRunning}/5`;
            
            if (currentRunning >= 5) {
                runningCountElement.className = 'ms-3 text-danger fw-bold';
            } else {
                runningCountElement.className = 'ms-3 text-muted';
            }
        }

        // Fetch spider status from API
        function fetchSpiderStatus() {
            fetch('/api/scraper/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSpiderTable(data.spiders);
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        // Update spider table with current data
        function updateSpiderTable(spiders) {
            const table = document.getElementById('spiderTable');
            
            // Update running spiders set
            runningSpiders.clear();
            spiders.forEach(spider => {
                if (spider.running_status === 'running') {
                    runningSpiders.add(spider.name);
                }
            });
            
            // Recreate table
            table.innerHTML = '';
            spiders.forEach((spider, idx) => {
                const row = createSpiderRow(spider, idx);
                table.appendChild(row);
            });
            
            updateRunningCount();
        }

        // Create spider row
        function createSpiderRow(spider, idx) {
            const row = document.createElement('tr');
            const statusInfo = getStatusInfo(spider.status);
            const runningStatusInfo = getRunningStatusInfo(spider.running_status);
            const isRunning = spider.running_status === 'running';
            const isScheduled = spider.status === 'scheduled';
            const isDisabled = spider.status === 'disabled';
            const isError = spider.running_status === 'error';

            // Button states
            const startButtonDisabled = isScheduled;
            const stopButtonDisabled = isDisabled;
            const runButtonDisabled = isRunning || runningSpiders.size >= 5;
            const runButtonSpinning = isRunning;

            row.innerHTML = `
                <td>${idx + 1}</td>
                <td><a href="${spiderSiteMap[spider.name] || '#'}" target="_blank">${spiderSiteMap[spider.name] || spider.name}</a></td>
                <td class="${statusInfo.class}">${statusInfo.label}</td>
                <td class="${runningStatusInfo.class}">${runningStatusInfo.label}</td>
                <td>${spider.last_update ? new Date(spider.last_update).toLocaleString() : ''}</td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="startSpider('${spider.name}')" 
                        ${startButtonDisabled ? 'disabled' : ''}>Start</button>
                    <button class="btn btn-sm btn-danger" onclick="stopSpider('${spider.name}')" 
                        ${stopButtonDisabled ? 'disabled' : ''}>Stop</button>
                    <button class="btn btn-sm btn-primary${runButtonSpinning ? ' btn-loading' : ''}" onclick="runSpider('${spider.name}')" 
                        id="run-${spider.name}" ${runButtonDisabled ? 'disabled' : ''}>Run</button>
                </td>
            `;
            return row;
        }

        // Run specific spider
        function runSpider(spiderName) {
            if (runningSpiders.size >= 5) {
                alert('Maximum limit reached! You can only run 5 spiders simultaneously.');
                return;
            }
            
            fetch('/api/scraper/immediate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [spiderName] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Immediately update status to show running state
                    fetchSpiderStatus();
                } else {
                    console.error('Failed to start spider:', data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Start specific spider
        function startSpider(spiderName) {
            fetch('/api/scraper/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [spiderName] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchSpiderStatus();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Stop specific spider
        function stopSpider(spiderName) {
            fetch('/api/scraper/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [spiderName] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchSpiderStatus();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Start all spiders
        function startAllSpiders() {
            fetch('/api/scraper/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchSpiderStatus();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Stop all spiders
        function stopAllSpiders() {
            fetch('/api/scraper/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spiders: [] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchSpiderStatus();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Initialize dashboard
        function initDashboard() {
            // Initial status fetch
            fetchSpiderStatus();
            
            // Start polling every 2 seconds
            statusPollingInterval = setInterval(fetchSpiderStatus, 2000);
        }

        // Start the dashboard
        initDashboard();
    </script>
</body>
</html> 